日期：2018-03-13
# 在机器10.77.100.66上执行下面脚本对feed_dnn在三台机器上做了测试。  
# 脚本执行方式如下：  
在10.77.100.66上操作步骤：
>cd /data0/users/changjun6/18010  
>./18010_test.sh
# 测试结果如下：
## 1.第一台内网机器10.22.2.192 
### （1） 环境 ##
机器: 10.22.2.192  
端口：18010  
机型：P73  
CPU：32个    
内存：120G

都打开了batching参数，具体设置如下

* 单个batch大小 15
* batch线程数 48
* batch队列的大小 48
* 其他参数默认

service配置：

* 版本 5.3.2
* worker count=32
* max_connection=1000
* log level = 3

样本：

* 特征为23个string类型数据，66个string类型数据，共89个
* 每次请求发送15条样本

### （2）方法 

使用service框架源码下的presstest工具（由`pluginservice-framework-multithread/client/cpp/src/main.cpp`编译而来）。
(修改后的源码路径在66上，/data1/usr/dingping/pluginservice-framework-multithread/client/cpp/src/main.cpp，如需求购，cd到src下的build目录，make即生成新的presstest二进制文件)

其中打印的日志:
    
* `grep "json presstest"` 为单个请求耗时
* `grep total` 为线程启动到线程结束总耗时，所以注意这个时间包括线程启动的开销

### （3）测试结果

#### CPU（log level = 3）  
从结果中可以看到，QPS最大约为`1000`    
testParams | aveTime(us) | totalTime(us) | qps
--- | --- | --- | ---
json_1_200000_1_100 | 17078.25000 | 1914256(us)	 | 52.23962
json_1_200000_10_100 | 18860.13300 | 2110494(us)	 | 473.82272
json_1_200000_20_100 | 24492.50800 | 2733782(us)	 | 731.58723
json_1_200000_50_100 | 46653.69620 | 5004253(us)	 | 999.15012
json_1_200000_100_100 | 96607.61570 | 10033729(us)	 | 996.63844
json_1_200000_200_100 | 193515.02115 | 19885491(us)	 | 1005.75842
json_1_200000_500_100 | 482857.78474 | 49568797(us)	 | 1008.69908
json_1_200000_1000_100 | 968371.50192 | 99153713(us)	 | 1008.53510  
  
**输入:** 

testParams | aveTime(us) | totalTime(us) | qps 
---|---|---|---
json_1_200000_1_100 | 17078.25000| 1914256 |52.23962 
num | 数字类型|单次请求的样本条数，需要和input字段中样本条数保持一致|"num":1
model | 字符串类型|模型名称，需要和模型配置文件models.conf中的模型名保持一致|"model":"mblog_yellow"
input|jsonArray|text: 文本内容<br>mid：微博id<br> pic_id：图片id| 见输入示例

## 2.第二台内网机器10.39.12.47
### （1） 环境 ##
机器: 10.39.12.47  
端口：18010  
机型：V71  
CPU：12个    
内存：62G
### （2）方法 
同上
### （3）测试结果

#### CPU（log level = 3）  
从结果中可以看到，QPS最大约为`260`  
testParams | aveTime(us) | totalTime(us) | qps
--- | --- | --- | ---
json_1_200000_1_100 | 34550.88000 | 3661970(us)	 | 27.30771
json_1_200000_10_100 | 41799.15800 | 4446189(us)	 | 224.91172
json_1_200000_20_100 | 76630.98650 | 8064844(us)	 | 247.98992
json_1_200000_50_100 | 175694.97240 | 19320149(us)	 | 258.79718
json_1_200000_100_100 | 363126.97540 | 38024277(us)	 | 262.98988
json_1_200000_200_100 | 743179.38995 | 76055458(us)	 | 262.96601
json_1_200000_500_100 | 1869803.38266 | 189656104(us)	 | 263.63507
json_1_200000_1000_100 | 3741977.32502 | 378055973(us)	 | 264.51110
## 3.第三台阿里云机器10.23.1.27
### （1） 环境 ##
机器: 10.23.1.27   
端口：18010  
CPU：56个    
内存：94G
### （2）方法 
同上
### （3）测试结果

#### CPU（log level = 3）  
从结果中可以看到，QPS最大约为`1000`    
testParams | aveTime(us) | totalTime(us) | qps
--- | --- | --- | ---
json_1_200000_1_100 | 17554.91000 | 1963342(us)	 | 50.93356
json_1_200000_10_100 | 22003.20800 | 2432936(us)	 | 411.02602
json_1_200000_20_100 | 27453.72500 | 3083052(us)	 | 648.70784
json_1_200000_50_100 | 48942.72900 | 5249896(us)	 | 952.39982
json_1_200000_100_100 | 93912.10380 | 9881799(us)	 | 1011.96149
json_1_200000_200_100 | 179357.77825 | 18524154(us)	 | 1079.67144
# 结果比较
机器 | CPU个数 | 内存(G)| aveTime(ms) | qps
--- | --- | --- | --- | --- | ---
10.22.2.192 | 32 | 120 | 17	 | 1000
10.39.12.47 | 12 | 62 | 34	 | 260
10.23.1.27 | 56 | 94 | 17	 | 1000

    
    

